# è§„åˆ™åº”è¯¥æ”¾åœ¨å“ªé‡Œï¼Ÿ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™ï¼šé…ç½®é©±åŠ¨ï¼ŒèŒè´£åˆ†ç¦»

### âŒ ä¸è¦æŠŠè§„åˆ™å†™åœ¨å¼•æ“ä»£ç é‡Œ

è§„åˆ™å¼•æ“ï¼ˆ`ruleengine/`ï¼‰çš„ä½œç”¨æ˜¯ï¼š
- **æ‰§è¡Œè§„åˆ™**ï¼Œä¸æ˜¯å®šä¹‰è§„åˆ™
- æä¾›**åŸå­å‡½æ•°**ï¼ˆbuilding blocksï¼‰
- æä¾›**æ‰§è¡Œæ¡†æ¶**ï¼ˆå·¥ä½œæµå¼•æ“ï¼‰

### âœ… è§„åˆ™åº”è¯¥å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ

è§„åˆ™åº”è¯¥é€šè¿‡ **API åˆ›å»ºå¹¶å­˜å‚¨åœ¨æ•°æ®åº“ä¸­**ï¼š

```
å‰ç«¯/API â†’ æ•°æ®åº“ (qc_ruleè¡¨) â†’ è§„åˆ™å¼•æ“æ‰§è¡Œ
```

## ğŸ“‹ æ¶æ„åˆ†å±‚

### 1. è§„åˆ™å¼•æ“å±‚ (`ruleengine/`)

**èŒè´£**ï¼šæä¾›æ‰§è¡Œèƒ½åŠ›å’ŒåŸå­å‡½æ•°

**åº”è¯¥å†™ä»€ä¹ˆ**ï¼š
- âœ… åŸå­å‡½æ•°ï¼ˆ`functions/`ï¼‰
  - `extract_field_content` - æå–å­—æ®µ
  - `count_characters` - ç»Ÿè®¡å­—ç¬¦
  - `component_missing` - æ£€æŸ¥æˆåˆ†ç¼ºå¤±
  - ç­‰ç­‰...

**ä¸åº”è¯¥å†™ä»€ä¹ˆ**ï¼š
- âŒ å…·ä½“çš„ä¸šåŠ¡è§„åˆ™
- âŒ è§„åˆ™é…ç½®JSON

### 2. æ•°æ®å±‚ (`models/rule.py`)

**èŒè´£**ï¼šå­˜å‚¨è§„åˆ™é…ç½®

**å­˜å‚¨å†…å®¹**ï¼š
- è§„åˆ™åç§°ã€æè¿°ã€æ¨¡å—
- è§„åˆ™é…ç½®JSONï¼ˆ`config` å­—æ®µï¼‰
- è§„åˆ™çŠ¶æ€ï¼ˆdraft/published/offlineï¼‰
- è§„åˆ™ç‰ˆæœ¬

### 3. æœåŠ¡å±‚ (`services/rule_service.py`)

**èŒè´£**ï¼šç®¡ç†è§„åˆ™ï¼ˆCRUDï¼‰

**åŠŸèƒ½**ï¼š
- åˆ›å»ºè§„åˆ™
- æ›´æ–°è§„åˆ™
- å‘å¸ƒè§„åˆ™
- æŸ¥è¯¢è§„åˆ™

### 4. APIå±‚ (`routers/rules.py`)

**èŒè´£**ï¼šæš´éœ²è§„åˆ™ç®¡ç†æ¥å£

**æ¥å£**ï¼š
- `POST /api/rules/` - åˆ›å»ºè§„åˆ™
- `GET /api/rules/` - æŸ¥è¯¢è§„åˆ™åˆ—è¡¨
- `PUT /api/rules/{id}` - æ›´æ–°è§„åˆ™
- `POST /api/rules/{id}/publish` - å‘å¸ƒè§„åˆ™

## ğŸ”„ è§„åˆ™çš„ç”Ÿå‘½å‘¨æœŸ

```
1. åˆ›å»ºè§„åˆ™ï¼ˆé€šè¿‡APIï¼‰
   â†“
   POST /api/rules/
   {
     "name": "ä¸»è¯‰å®Œæ•´æ€§æ£€æŸ¥",
     "config": {
       "rule_id": "ä¸»è¯‰å®Œæ•´æ€§æ£€æŸ¥_001",
       "function_list": {...}
     }
   }
   â†“
   å­˜å‚¨åˆ°æ•°æ®åº“ (qc_ruleè¡¨)

2. å‘å¸ƒè§„åˆ™
   â†“
   POST /api/rules/{id}/publish
   â†“
   çŠ¶æ€å˜ä¸º "published"

3. æ‰§è¡Œè§„åˆ™
   â†“
   POST /api/qc/execute
   {
     "rule_id": 1,  // æ•°æ®åº“ID
     "medical_record": {...}
   }
   â†“
   ä»æ•°æ®åº“è¯»å–è§„åˆ™é…ç½®
   â†“
   ä¼ ç»™ RuleEngine æ‰§è¡Œ
   â†“
   è¿”å›è´¨æ§ç»“æœ
```

## ğŸ’¡ ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

### 1. **çµæ´»æ€§**
- ä¿®æ”¹è§„åˆ™ä¸éœ€è¦æ”¹ä»£ç 
- å¯ä»¥é€šè¿‡å‰ç«¯ç•Œé¢é…ç½®è§„åˆ™
- æ”¯æŒè§„åˆ™ç‰ˆæœ¬ç®¡ç†

### 2. **å¯ç»´æŠ¤æ€§**
- è§„åˆ™å’Œä»£ç åˆ†ç¦»
- è§„åˆ™å¯ä»¥ç‹¬ç«‹æµ‹è¯•
- æ˜“äºå›æ»šå’Œç‰ˆæœ¬æ§åˆ¶

### 3. **å¯æ‰©å±•æ€§**
- æ–°å¢è§„åˆ™ä¸éœ€è¦é‡æ–°éƒ¨ç½²
- æ”¯æŒè§„åˆ™æ¨¡æ¿å’Œæ‰¹é‡å¯¼å…¥
- ä¾¿äºè§„åˆ™å¤ç”¨

### 4. **é€‚åˆæ¯•è®¾å±•ç¤º**
- ä½“ç°é…ç½®é©±åŠ¨çš„è®¾è®¡æ€æƒ³
- å±•ç¤ºæ•°æ®åº“è®¾è®¡èƒ½åŠ›
- å±•ç¤ºAPIè®¾è®¡èƒ½åŠ›

## ğŸ“ å®é™…å·¥ä½œæµç¨‹

### æ­¥éª¤1ï¼šåœ¨å¼•æ“ä¸­æ·»åŠ åŸå­å‡½æ•°

```python
# backend/ruleengine/functions/text_analyze.py

@register_function(
    name="component_missing",
    description="æ£€æŸ¥æ–‡æœ¬æ˜¯å¦ç¼ºå¤±å¿…è¦æˆåˆ†",
    ...
)
def component_missing(text: str, components: str) -> dict:
    # å®ç°æ£€æŸ¥é€»è¾‘
    ...
```

### æ­¥éª¤2ï¼šé€šè¿‡APIåˆ›å»ºè§„åˆ™

```bash
POST /api/rules/
{
  "name": "ä¸»è¯‰å®Œæ•´æ€§æ£€æŸ¥",
  "config": {
    "rule_id": "ä¸»è¯‰å®Œæ•´æ€§æ£€æŸ¥_001",
    "function_list": {
      "nodes": [
        {
          "id": 1,
          "function": "extract_field_content",
          "params": {"field_name": ["å…¥é™¢è®°å½•", "ä¸»è¯‰"]},
          "outputs": {"text": "result"}
        },
        {
          "id": 2,
          "function": "component_missing",
          "params": {
            "text": {"source": 1, "output": "text"},
            "components": "æ—¶é—´ã€ç—‡çŠ¶"
          },
          "outputs": {"is_missing": "result"}
        }
      ],
      "result_rule": {
        "pass": {"source": 2, "output": "is_missing", "expect": false}
      }
    }
  }
}
```

### æ­¥éª¤3ï¼šæ‰§è¡Œè§„åˆ™

```bash
POST /api/qc/execute
{
  "rule_id": 1,
  "medical_record": {...}
}
```

## ğŸ“ æ€»ç»“

- **å¼•æ“é‡Œå†™**ï¼šåŸå­å‡½æ•°ï¼ˆå¯å¤ç”¨çš„building blocksï¼‰
- **æ•°æ®åº“å­˜**ï¼šè§„åˆ™é…ç½®ï¼ˆä¸šåŠ¡è§„åˆ™å®šä¹‰ï¼‰
- **APIç®¡ç†**ï¼šè§„åˆ™çš„åˆ›å»ºã€æ›´æ–°ã€å‘å¸ƒ
- **å¼•æ“æ‰§è¡Œ**ï¼šè¯»å–é…ç½®ï¼Œæ‰§è¡Œè§„åˆ™

è¿™æ ·çš„è®¾è®¡è®©ç³»ç»Ÿæ›´åŠ çµæ´»ã€å¯ç»´æŠ¤ï¼Œä¹Ÿæ›´èƒ½ä½“ç°ä½ çš„æ¶æ„è®¾è®¡èƒ½åŠ›ï¼

